<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>第9章：检索增强生成（RAG）基础</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>目录</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="搜索..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">从零构建聊天机器人：算法、数据与实践完全指南（21章完整版）</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第1章：聊天机器人架构概览</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第2章：聊天机器人的语言模型基础</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第3章：聊天机器人的提示工程</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第4章：聊天机器人的高级推理</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第5章：上下文管理与对话状态</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第6章：聊天机器人的个性化与社交功能</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第7章：微调技术深度剖析</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第8章：人类反馈强化学习（RLHF/DPO）</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第9章：检索增强生成（RAG）基础</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第10章：高级RAG技术</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第11章：AI搜索与外部知识集成</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第12章：生成式检索新范式</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第13章：多模态文档理解</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第14章：多模态大语言模型（MLLM/VLM）</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第15章：传统语音交互系统</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第16章：端到端语音对话系统</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter17.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第17章：多模态RAG系统</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter18.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第18章：推理优化技术</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter19.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第19章：安全性与内容过滤</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter20.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第20章：监控与持续改进</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter21.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第21章：生产环境部署实战</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="9rag">第9章：检索增强生成（RAG）基础</h1>
<h2 id="_1">章节概览</h2>
<p>检索增强生成（Retrieval-Augmented Generation, RAG）是现代聊天机器人突破知识边界的关键技术。本章将深入探讨如何构建一个高效的RAG系统，使聊天机器人能够动态获取和利用外部知识，实现更准确、更实时的对话响应。我们将从RAG的基本架构开始，逐步深入到针对聊天场景的优化策略，重点解决实时对话中的延迟问题和检索准确性挑战。</p>
<h2 id="91-rag">9.1 知识型聊天机器人的RAG架构</h2>
<h3 id="911-rag">9.1.1 RAG的核心动机</h3>
<p>传统的预训练语言模型存在三个根本性局限：</p>
<ol>
<li><strong>知识时效性问题</strong>：模型的知识截止于训练时间点，无法获取最新信息</li>
<li><strong>幻觉问题</strong>：模型可能生成看似合理但事实错误的内容</li>
<li><strong>知识容量限制</strong>：参数化知识存储效率低，难以覆盖长尾知识</li>
</ol>
<p>RAG通过将生成模型与外部知识库结合，优雅地解决了这些问题。其核心思想是：与其让模型记住所有知识，不如让它学会如何检索和利用知识。</p>
<h3 id="912-rag">9.1.2 RAG的基本流程</h3>
<div class="codehilite"><pre><span></span><code>用户查询 → 查询编码 → 向量检索 → 文档重排序 → 上下文构建 → 生成回答
    ↑                                                            ↓
    ←←←←←←←←←←←←←←← 对话历史更新 ←←←←←←←←←←←←←←←←←←←←←
</code></pre></div>

<p>标准RAG流程包含以下关键步骤：</p>
<ol>
<li>
<p><strong>查询理解与改写</strong>
- 解析用户意图，识别信息需求
- 基于对话历史扩展查询上下文
- 生成多个检索查询以提高召回率</p>
</li>
<li>
<p><strong>文档检索</strong>
- 将查询编码为密集向量表示
- 在向量数据库中执行近似最近邻搜索
- 返回TopK个最相关文档片段</p>
</li>
<li>
<p><strong>相关性重排序</strong>
- 使用交叉编码器对检索结果精排
- 考虑文档新鲜度、权威性等因素
- 过滤重复或低质量内容</p>
</li>
<li>
<p><strong>上下文构建</strong>
- 将检索文档组织成结构化上下文
- 处理文档间的依赖关系
- 控制上下文长度在模型限制内</p>
</li>
<li>
<p><strong>增强生成</strong>
- 将上下文与用户查询结合
- 生成基于检索知识的回答
- 添加引用标注增强可信度</p>
</li>
</ol>
<h3 id="913">9.1.3 聊天场景的特殊考虑</h3>
<p>聊天机器人的RAG系统需要处理对话特有的挑战：</p>
<p><strong>多轮依赖性</strong>
对话中的查询往往依赖于前文语境。例如：</p>
<ul>
<li>用户："特斯拉最新的财报如何？"</li>
<li>助手：[检索并回答]</li>
<li>用户："他们的自动驾驶业务呢？"（"他们"指代特斯拉）</li>
</ul>
<p>这要求RAG系统能够：</p>
<ul>
<li>维护对话状态，解析指代关系</li>
<li>将历史对话纳入检索查询</li>
<li>避免重复检索已讨论内容</li>
</ul>
<p><strong>实时性要求</strong>
聊天交互对延迟极其敏感。研究表明：</p>
<ul>
<li>100ms以内：用户感知为即时响应</li>
<li>100-300ms：可接受的快速响应</li>
<li>300-1000ms：用户明显感知延迟</li>
<li>
<blockquote>
<p>1000ms：影响对话流畅性</p>
</blockquote>
</li>
</ul>
<p><strong>知识一致性</strong>
在多轮对话中，机器人需要保持知识的一致性：</p>
<ul>
<li>避免前后矛盾的陈述</li>
<li>记住已检索的事实</li>
<li>在后续回答中复用相关知识</li>
</ul>
<h3 id="914">9.1.4 架构设计模式</h3>
<p><strong>模式1：串行RAG</strong></p>
<div class="codehilite"><pre><span></span><code>Query → Retrieve → Generate
</code></pre></div>

<p>最简单的实现，适合低并发场景。</p>
<p><strong>模式2：并行RAG</strong></p>
<div class="codehilite"><pre><span></span><code>Query → [Retrieve1, Retrieve2, ...] → Merge → Generate
</code></pre></div>

<p>同时检索多个知识源，提高召回率。</p>
<p><strong>模式3：迭代RAG</strong></p>
<div class="codehilite"><pre><span></span><code>Query → Retrieve → Generate → Evaluate → [需要更多信息?] → Query&#39;
</code></pre></div>

<p>根据生成质量动态决定是否需要额外检索。</p>
<p><strong>模式4：自适应RAG</strong></p>
<div class="codehilite"><pre><span></span><code>Query → Intent Classification → [选择检索策略] → Retrieve → Generate
</code></pre></div>

<p>根据查询类型选择不同的检索和生成策略。</p>
<h2 id="92">9.2 对话历史与知识库的双重检索</h2>
<h3 id="921">9.2.1 双索引架构设计</h3>
<p>在聊天机器人中，我们需要同时检索两类信息：</p>
<ol>
<li><strong>对话历史索引</strong>：存储用户的历史对话，支持个性化和上下文连续性</li>
<li><strong>知识库索引</strong>：存储外部知识文档，提供事实性信息</li>
</ol>
<p>双索引架构的关键设计：</p>
<div class="codehilite"><pre><span></span><code>┌─────────────────┐     ┌─────────────────┐
│  对话历史索引    │     │   知识库索引     │
├─────────────────┤     ├─────────────────┤
│ • 用户ID分片     │     │ • 主题分类      │
│ • 时间戳排序     │     │ • 文档版本控制   │
│ • 会话分组      │     │ • 权威度评分     │
│ • 情感标注      │     │ • 更新时间戳     │
└─────────────────┘     └─────────────────┘
         ↓                       ↓
    历史向量化               知识向量化
         ↓                       ↓
    ┌────────────────────────────┐
    │      融合检索器            │
    │  • 相关性加权             │
    │  • 时效性平衡             │
    │  • 去重与合并             │
    └────────────────────────────┘
</code></pre></div>

<h3 id="922">9.2.2 对话历史的索引策略</h3>
<p><strong>分层索引结构</strong></p>
<div class="codehilite"><pre><span></span><code>用户级 → 会话级 → 轮次级
  │        │         │
  │        │         └─ 单轮对话embedding
  │        └─ 会话摘要embedding
  └─ 用户画像embedding
</code></pre></div>

<p><strong>索引粒度选择</strong></p>
<ol>
<li>
<p><strong>细粒度索引</strong>（单轮对话）
   - 优点：精确定位相关对话
   - 缺点：索引体积大，检索开销高
   - 适用：需要精确引用历史的场景</p>
</li>
<li>
<p><strong>中粒度索引</strong>（话题段落）
   - 优点：保留语境，减少索引量
   - 缺点：需要话题分割算法
   - 适用：多轮深度对话场景</p>
</li>
<li>
<p><strong>粗粒度索引</strong>（会话摘要）
   - 优点：索引紧凑，检索快速
   - 缺点：细节信息丢失
   - 适用：长期记忆和用户画像</p>
</li>
</ol>
<p><strong>时间衰减机制</strong></p>
<p>对话历史的相关性随时间衰减，可以使用指数衰减函数：</p>
<p>$$\text{score}_{\text{final}} = \text{score}_{\text{semantic}} \cdot e^{-\lambda \cdot \Delta t}$$
其中：</p>
<ul>
<li>$\text{score}_{\text{semantic}}$：语义相似度得分</li>
<li>$\Delta t$：时间间隔（小时/天）</li>
<li>$\lambda$：衰减系数（经验值0.01-0.1）</li>
</ul>
<h3 id="923">9.2.3 知识库的结构化组织</h3>
<p><strong>层次化知识组织</strong></p>
<div class="codehilite"><pre><span></span><code>领域 → 主题 → 文档 → 段落 → 句子
 │      │      │      │      │
 │      │      │      │      └─ 事实三元组
 │      │      │      └─ 段落embedding
 │      │      └─ 文档元数据
 │      └─ 主题关键词
 └─ 领域本体
</code></pre></div>

<p><strong>知识图谱增强</strong></p>
<p>将非结构化文本与结构化知识图谱结合：</p>
<ol>
<li><strong>实体链接</strong>：识别文本中的实体并链接到知识图谱</li>
<li><strong>关系抽取</strong>：提取实体间的关系，构建局部子图</li>
<li><strong>图检索</strong>：基于图结构进行多跳推理检索</li>
</ol>
<h3 id="924">9.2.4 融合检索策略</h3>
<p><strong>加权融合公式</strong>
$$\text{score}_{\text{fusion}} = \alpha \cdot \text{score}_{\text{history}} + \beta \cdot \text{score}_{\text{knowledge}} + \gamma \cdot \text{score}_{\text{recency}}$$
其中权重 $\alpha, \beta, \gamma$ 可以根据查询类型动态调整：</p>
<ul>
<li><strong>事实型查询</strong>：提高 $\beta$（知识库权重）</li>
<li><strong>个人化查询</strong>：提高 $\alpha$（历史权重）</li>
<li><strong>时事查询</strong>：提高 $\gamma$（时效性权重）</li>
</ul>
<p><strong>去重与合并算法</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># 伪代码示例</span>
<span class="k">def</span> <span class="nf">merge_results</span><span class="p">(</span><span class="n">history_docs</span><span class="p">,</span> <span class="n">knowledge_docs</span><span class="p">):</span>
    <span class="c1"># 1. 语义去重</span>
    <span class="n">unique_docs</span> <span class="o">=</span> <span class="n">semantic_dedup</span><span class="p">(</span><span class="n">history_docs</span> <span class="o">+</span> <span class="n">knowledge_docs</span><span class="p">)</span>

    <span class="c1"># 2. 互补性评分</span>
    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">unique_docs</span><span class="p">:</span>
        <span class="n">doc</span><span class="o">.</span><span class="n">complementarity</span> <span class="o">=</span> <span class="n">calc_info_gain</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

    <span class="c1"># 3. 多样性采样</span>
    <span class="n">final_docs</span> <span class="o">=</span> <span class="n">mmr_sampling</span><span class="p">(</span><span class="n">unique_docs</span><span class="p">,</span> <span class="n">lambda_param</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">final_docs</span>
</code></pre></div>

<h2 id="93">9.3 聊天场景的嵌入模型选择</h2>
<h3 id="931">9.3.1 嵌入模型的关键指标</h3>
<ol>
<li>
<p><strong>语义理解能力</strong>
- 同义词识别：能否识别"买"和"购买"的相似性
- 上下文理解：能否区分"苹果公司"和"苹果水果"
- 多语言支持：中英混合查询的处理能力</p>
</li>
<li>
<p><strong>计算性能指标</strong>
- 编码速度：每秒处理的token数
- 向量维度：影响存储和检索成本（常见：384, 768, 1024, 1536）
- 模型大小：影响部署资源需求</p>
</li>
<li>
<p><strong>领域适应性</strong>
- 预训练覆盖度：是否包含目标领域语料
- 微调潜力：能否通过少量数据适应新领域
- 指令跟随：是否支持任务特定的编码指令</p>
</li>
</ol>
<h3 id="932">9.3.2 主流嵌入模型对比</h3>
<p><strong>通用模型</strong></p>
<p>| 模型 | 维度 | 特点 | 适用场景 |</p>
<table>
<thead>
<tr>
<th>模型</th>
<th>维度</th>
<th>特点</th>
<th>适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td>BGE-large-zh</td>
<td>1024</td>
<td>中文优化，性能均衡</td>
<td>中文为主的聊天系统</td>
</tr>
<tr>
<td>E5-large</td>
<td>1024</td>
<td>多语言，指令增强</td>
<td>多语言聊天机器人</td>
</tr>
<tr>
<td>GTE-large</td>
<td>1024</td>
<td>通用性强，效果稳定</td>
<td>通用知识问答</td>
</tr>
<tr>
<td>OpenAI text-embedding-3</td>
<td>1536/3072</td>
<td>效果最优，成本较高</td>
<td>高价值商业应用</td>
</tr>
</tbody>
</table>
<p><strong>对话专用模型</strong></p>
<p>| 模型 | 特点 | 优化方向 |</p>
<table>
<thead>
<tr>
<th>模型</th>
<th>特点</th>
<th>优化方向</th>
</tr>
</thead>
<tbody>
<tr>
<td>ConvBERT</td>
<td>对话上下文建模</td>
<td>多轮对话理解</td>
</tr>
<tr>
<td>DialogueRoBERTa</td>
<td>对话行为识别</td>
<td>意图理解</td>
</tr>
<tr>
<td>TOD-BERT</td>
<td>任务导向对话</td>
<td>槽位填充</td>
</tr>
</tbody>
</table>
<h3 id="933">9.3.3 对话查询的编码优化</h3>
<p><strong>查询扩展技术</strong></p>
<ol>
<li><strong>同义词扩展</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code>原始：&quot;怎么退货&quot;
扩展：&quot;如何退货&quot;, &quot;退货流程&quot;, &quot;申请退款&quot;
</code></pre></div>

<ol start="2">
<li><strong>上下文注入</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code>原始：&quot;多少钱&quot;
注入：&quot;[商品:iPhone 15] 多少钱&quot;
</code></pre></div>

<ol start="3">
<li><strong>假设文档生成（HyDE）</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code>查询：&quot;量子计算的原理&quot;
生成假设答案：&quot;量子计算利用量子叠加态和纠缠...&quot;
使用假设答案的embedding进行检索
</code></pre></div>

<p><strong>对话特征增强</strong></p>
<p>在标准文本embedding基础上，添加对话特有特征：
$$\text{emb}_{\text{final}} = \text{emb}_{\text{text}} \oplus \text{emb}_{\text{intent}} \oplus \text{emb}_{\text{emotion}}$$
其中：</p>
<ul>
<li>$\text{emb}_{\text{text}}$：基础文本embedding</li>
<li>$\text{emb}_{\text{intent}}$：意图类别embedding</li>
<li>$\text{emb}_{\text{emotion}}$：情感特征embedding</li>
<li>$\oplus$：特征拼接或加权融合</li>
</ul>
<h3 id="934">9.3.4 嵌入模型的微调策略</h3>
<p><strong>对比学习框架</strong></p>
<p>使用三元组损失训练：
$$L = \max(0, d(q, p^+) - d(q, p^-) + \text{margin})$$
其中：</p>
<ul>
<li>$q$：查询embedding</li>
<li>$p^+$：正样本（相关文档）</li>
<li>$p^-$：负样本（不相关文档）</li>
<li>$d$：距离函数（通常为余弦距离）</li>
</ul>
<p><strong>难负例挖掘</strong></p>
<ol>
<li><strong>BM25负例</strong>：使用BM25检索的高分但不相关文档</li>
<li><strong>批内负例</strong>：同批次其他查询的正样本</li>
<li><strong>对抗负例</strong>：语义相似但答案不同的文档</li>
</ol>
<p><strong>增量学习</strong></p>
<p>避免灾难性遗忘的策略：</p>
<ul>
<li>弹性权重巩固（EWC）</li>
<li>经验回放</li>
<li>知识蒸馏</li>
</ul>
<h2 id="94">9.4 实时对话中的检索延迟优化</h2>
<h3 id="941">9.4.1 延迟分析与瓶颈识别</h3>
<p><strong>延迟分解</strong></p>
<div class="codehilite"><pre><span></span><code>总延迟 = 查询处理 + 向量检索 + 重排序 + 上下文构建 + 模型生成
       = 10ms + 50ms + 30ms + 20ms + 500ms
       = 610ms
</code></pre></div>

<p>典型的延迟分布：</p>
<ul>
<li>查询处理：5-20ms</li>
<li>向量检索：30-100ms（取决于索引规模）</li>
<li>重排序：20-50ms</li>
<li>上下文构建：10-30ms</li>
<li>模型生成：200-2000ms（流式可优化体感）</li>
</ul>
<h3 id="942">9.4.2 向量索引优化</h3>
<p><strong>索引算法选择</strong></p>
<p>| 算法 | 构建时间 | 查询时间 | 内存占用 | 召回率 |</p>
<table>
<thead>
<tr>
<th>算法</th>
<th>构建时间</th>
<th>查询时间</th>
<th>内存占用</th>
<th>召回率</th>
</tr>
</thead>
<tbody>
<tr>
<td>Flat</td>
<td>O(1)</td>
<td>O(n)</td>
<td>低</td>
<td>100%</td>
</tr>
<tr>
<td>IVF</td>
<td>O(n)</td>
<td>O(√n)</td>
<td>中</td>
<td>95%+</td>
</tr>
<tr>
<td>HNSW</td>
<td>O(n log n)</td>
<td>O(log n)</td>
<td>高</td>
<td>98%+</td>
</tr>
<tr>
<td>ScaNN</td>
<td>O(n)</td>
<td>O(√n)</td>
<td>中</td>
<td>96%+</td>
</tr>
</tbody>
</table>
<p><strong>HNSW参数调优</strong></p>
<p>关键参数：</p>
<ul>
<li><code>M</code>：每个节点的连接数（16-64）</li>
<li><code>ef_construction</code>：构建时的动态列表大小（200-500）</li>
<li><code>ef_search</code>：搜索时的动态列表大小（50-200）</li>
</ul>
<p>调优原则：</p>
<div class="codehilite"><pre><span></span><code>高召回率需求：M↑, ef_search↑
低延迟需求：M↓, ef_search↓
平衡点：M=32, ef_search=100
</code></pre></div>

<p><strong>分片与并行化</strong></p>
<div class="codehilite"><pre><span></span><code>索引分片策略：
├─ 按时间分片（最近7天、30天、历史）
├─ 按主题分片（技术、商业、生活）
└─ 按热度分片（热门、常规、长尾）

并行查询：
Query → [Shard1, Shard2, ..., ShardN] → Merge
</code></pre></div>

<h3 id="943">9.4.3 缓存策略</h3>
<p><strong>多级缓存架构</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">L1</span><span class="o">:</span><span class="w"> </span><span class="err">查询缓存（</span><span class="n">Redis</span><span class="err">）</span><span class="o">-</span><span class="w"> </span><span class="err">完全匹配，命中率</span><span class="mi">5</span><span class="o">-</span><span class="mi">10</span><span class="o">%</span>
<span class="n">L2</span><span class="o">:</span><span class="w"> </span><span class="err">语义缓存（向量相似）</span><span class="o">-</span><span class="w"> </span><span class="err">相似查询，命中率</span><span class="mi">20</span><span class="o">-</span><span class="mi">30</span><span class="o">%</span>
<span class="n">L3</span><span class="o">:</span><span class="w"> </span><span class="err">文档缓存（</span><span class="n">CDN</span><span class="err">）</span><span class="o">-</span><span class="w"> </span><span class="err">热门文档，命中率</span><span class="mi">40</span><span class="o">-</span><span class="mi">50</span><span class="o">%</span>
</code></pre></div>

<p><strong>语义缓存实现</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># 伪代码</span>
<span class="k">def</span> <span class="nf">semantic_cache_get</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.95</span><span class="p">):</span>
    <span class="n">query_emb</span> <span class="o">=</span> <span class="n">encode</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="c1"># 在缓存中查找相似查询</span>
    <span class="n">cached_queries</span> <span class="o">=</span> <span class="n">cache_index</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query_emb</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">cached_q</span> <span class="ow">in</span> <span class="n">cached_queries</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cosine_sim</span><span class="p">(</span><span class="n">query_emb</span><span class="p">,</span> <span class="n">cached_q</span><span class="o">.</span><span class="n">emb</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cached_q</span><span class="o">.</span><span class="n">result</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>

<p><strong>缓存更新策略</strong></p>
<ol>
<li><strong>LRU + 热度权重</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code>score = recency_score <span class="gs">* 0.3 + frequency_score *</span> 0.7
</code></pre></div>

<ol start="2">
<li><strong>TTL差异化</strong>
   - 事实性内容：24小时
   - 时事内容：1小时
   - 个性化内容：7天</li>
</ol>
<h3 id="944">9.4.4 流式生成优化</h3>
<p><strong>渐进式上下文构建</strong></p>
<div class="codehilite"><pre><span></span><code>阶段1 (0-100ms): 使用缓存/简单检索 → 开始生成
阶段2 (100-300ms): 深度检索完成 → 补充生成
阶段3 (300ms+): 重排序完成 → 质量优化
</code></pre></div>

<p><strong>推测性检索</strong></p>
<p>基于用户输入模式预测可能的查询：</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">speculative_retrieve</span><span class="p">(</span><span class="n">partial_query</span><span class="p">):</span>
    <span class="c1"># 基于前缀预测完整查询</span>
    <span class="n">predicted_queries</span> <span class="o">=</span> <span class="n">complete_query</span><span class="p">(</span><span class="n">partial_query</span><span class="p">)</span>
    <span class="c1"># 提前检索</span>
    <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="n">predicted_queries</span><span class="p">:</span>
        <span class="n">async_retrieve</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</code></pre></div>

<p><strong>检索与生成的流水线并行</strong></p>
<div class="codehilite"><pre><span></span><code>Token[1:k] 生成 ← Context[1:m]
Token[k+1:2k] 生成 ← Context[1:m] + Context[m+1:n]（增量）
</code></pre></div>

<h3 id="945">9.4.5 边缘计算与本地索引</h3>
<p><strong>混合部署架构</strong></p>
<div class="codehilite"><pre><span></span><code>客户端（边缘）          云端
├─ 小规模本地索引      ├─ 完整知识库
├─ 个人化缓存         ├─ 实时更新
├─ 轻量编码器         ├─ 重排序服务
└─ 快速预检索         └─ 深度检索
</code></pre></div>

<p><strong>本地索引选择标准</strong></p>
<ol>
<li>高频访问内容</li>
<li>用户个性化数据</li>
<li>低延迟要求的基础知识</li>
<li>离线可用的核心功能</li>
</ol>
<h2 id="_2">本章小结</h2>
<p>本章深入探讨了检索增强生成（RAG）在聊天机器人中的应用基础。核心要点包括：</p>
<h3 id="_3">关键概念回顾</h3>
<ol>
<li>
<p><strong>RAG架构设计</strong>
   - 解决了预训练模型的知识时效性、幻觉和容量限制问题
   - 标准流程：查询理解→检索→重排序→上下文构建→增强生成
   - 聊天场景需特别处理多轮依赖、实时性和知识一致性</p>
</li>
<li>
<p><strong>双重检索系统</strong>
   - 对话历史索引：支持个性化和上下文连续性
   - 知识库索引：提供外部事实性信息
   - 融合策略：动态权重调整，语义去重，多样性采样</p>
</li>
<li>
<p><strong>嵌入模型选择</strong>
   - 评估维度：语义理解、计算性能、领域适应性
   - 对话优化：查询扩展、上下文注入、特征增强
   - 微调策略：对比学习、难负例挖掘、增量学习</p>
</li>
<li>
<p><strong>延迟优化技术</strong>
   - 索引优化：HNSW参数调优、分片并行
   - 多级缓存：查询缓存、语义缓存、文档缓存
   - 流式生成：渐进式构建、推测性检索、流水线并行</p>
</li>
</ol>
<h3 id="_4">核心公式总结</h3>
<ol>
<li>
<p><strong>时间衰减公式</strong>：
$$\text{score}_{\text{final}} = \text{score}_{\text{semantic}} \cdot e^{-\lambda \cdot \Delta t}$$</p>
</li>
<li>
<p><strong>融合检索公式</strong>：
$$\text{score}_{\text{fusion}} = \alpha \cdot \text{score}_{\text{history}} + \beta \cdot \text{score}_{\text{knowledge}} + \gamma \cdot \text{score}_{\text{recency}}$$</p>
</li>
<li>
<p><strong>对话特征增强</strong>：
$$\text{emb}_{\text{final}} = \text{emb}_{\text{text}} \oplus \text{emb}_{\text{intent}} \oplus \text{emb}_{\text{emotion}}$$</p>
</li>
<li>
<p><strong>对比学习损失</strong>：
$$L = \max(0, d(q, p^+) - d(q, p^-) + \text{margin})$$</p>
</li>
</ol>
<h3 id="_5">实践建议</h3>
<ol>
<li><strong>从简单开始</strong>：先实现基础RAG流程，再逐步优化</li>
<li><strong>监控关键指标</strong>：延迟、召回率、准确率、用户满意度</li>
<li><strong>A/B测试</strong>：不同检索策略和模型的效果对比</li>
<li><strong>持续迭代</strong>：基于用户反馈优化检索和生成质量</li>
</ol>
<h2 id="gotchas">常见陷阱与错误（Gotchas）</h2>
<h3 id="1">1. 检索质量问题</h3>
<p><strong>陷阱：过度依赖语义相似度</strong></p>
<ul>
<li>问题：语义相似不等于答案相关</li>
<li>示例："如何删除文件"可能检索到"如何创建文件"</li>
<li>解决：结合关键词匹配、意图分类、答案验证</li>
</ul>
<p><strong>陷阱：忽视检索多样性</strong></p>
<ul>
<li>问题：TopK结果高度相似，信息冗余</li>
<li>示例：检索到5个几乎相同的文档片段</li>
<li>解决：使用MMR（最大边际相关性）算法平衡相关性和多样性</li>
</ul>
<h3 id="2">2. 上下文构建错误</h3>
<p><strong>陷阱：上下文顺序随意</strong></p>
<ul>
<li>问题：文档顺序影响生成质量</li>
<li>现象：模型倾向于依赖前面的文档</li>
<li>解决：按相关性降序排列，重要信息前置</li>
</ul>
<p><strong>陷阱：上下文过长导致"中间遗忘"</strong></p>
<ul>
<li>问题：模型对中间位置的信息利用率低</li>
<li>研究：U形注意力模式，两端信息利用率高</li>
<li>解决：控制上下文长度，关键信息重复或强调</li>
</ul>
<h3 id="3">3. 延迟优化误区</h3>
<p><strong>陷阱：过度优化检索延迟</strong></p>
<ul>
<li>问题：牺牲检索质量换取速度</li>
<li>后果：生成质量下降，需要多轮澄清</li>
<li>平衡：设定质量底线，在此基础上优化速度</li>
</ul>
<p><strong>陷阱：忽视冷启动延迟</strong></p>
<ul>
<li>问题：首次查询延迟显著高于后续查询</li>
<li>原因：索引加载、模型初始化、缓存未命中</li>
<li>解决：预热机制、常驻内存、异步加载</li>
</ul>
<h3 id="4">4. 对话场景特有问题</h3>
<p><strong>陷阱：指代消解失败</strong></p>
<ul>
<li>问题："它"、"这个"等代词未正确解析</li>
<li>示例："特斯拉怎么样？"→"它的股价呢？"</li>
<li>解决：维护实体追踪，显式指代消解</li>
</ul>
<p><strong>陷阱：历史信息过度影响</strong></p>
<ul>
<li>问题：错误的历史信息被反复强化</li>
<li>示例：用户纠正后仍使用错误的历史</li>
<li>解决：支持历史修正，降低错误信息权重</li>
</ul>
<h3 id="5">5. 系统集成问题</h3>
<p><strong>陷阱：向量维度不匹配</strong></p>
<ul>
<li>问题：查询和文档使用不同维度的模型</li>
<li>后果：检索完全失效</li>
<li>预防：统一模型版本，添加维度检查</li>
</ul>
<p><strong>陷阱：编码不一致</strong></p>
<ul>
<li>问题：索引和查询时的预处理不同</li>
<li>示例：索引时分词，查询时未分词</li>
<li>解决：封装统一的预处理pipeline</li>
</ul>
<h3 id="6">6. 成本控制失误</h3>
<p><strong>陷阱：embedding API调用过多</strong></p>
<ul>
<li>问题：每次查询都重新编码相同内容</li>
<li>成本：API调用费用快速增长</li>
<li>优化：缓存常见查询的embedding</li>
</ul>
<p><strong>陷阱：检索范围过大</strong></p>
<ul>
<li>问题：全库检索，即使查询明确指向特定领域</li>
<li>优化：查询路由，分层检索，早停机制</li>
</ul>
<h3 id="_6">调试技巧</h3>
<ol>
<li><strong>检索调试</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># 可视化检索结果</span>
<span class="k">def</span> <span class="nf">debug_retrieval</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Query: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">doc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">] Score: </span><span class="si">{</span><span class="n">doc</span><span class="o">.</span><span class="n">score</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      Preview: </span><span class="si">{</span><span class="n">doc</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      Source: </span><span class="si">{</span><span class="n">doc</span><span class="o">.</span><span class="n">metadata</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<ol start="2">
<li><strong>延迟分析</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># 分段计时</span>
<span class="k">with</span> <span class="n">TimeProfiler</span><span class="p">()</span> <span class="k">as</span> <span class="n">profiler</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">profiler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="s2">&quot;encoding&quot;</span><span class="p">):</span>
        <span class="n">query_emb</span> <span class="o">=</span> <span class="n">encode</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">profiler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="s2">&quot;retrieval&quot;</span><span class="p">):</span>
        <span class="n">docs</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query_emb</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">profiler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="s2">&quot;reranking&quot;</span><span class="p">):</span>
        <span class="n">docs</span> <span class="o">=</span> <span class="n">rerank</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">docs</span><span class="p">)</span>
<span class="n">profiler</span><span class="o">.</span><span class="n">report</span><span class="p">()</span>
</code></pre></div>

<ol start="3">
<li><strong>质量评估</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># A/B测试框架</span>
<span class="k">def</span> <span class="nf">evaluate_rag_variant</span><span class="p">(</span><span class="n">variant_name</span><span class="p">,</span> <span class="n">test_queries</span><span class="p">):</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;latency&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;relevance&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;answer_quality&#39;</span><span class="p">:</span> <span class="p">[]</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="n">test_queries</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">rag_variants</span><span class="p">[</span><span class="n">variant_name</span><span class="p">](</span><span class="n">query</span><span class="p">)</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;latency&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">latency</span><span class="p">)</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;relevance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">judge_relevance</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;answer_quality&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">judge_quality</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">aggregate_metrics</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
</code></pre></div>

<h2 id="_7">练习题</h2>
<h3 id="_8">基础题</h3>
<p><strong>练习9.1：RAG流程理解</strong></p>
<p>设计一个简单的RAG系统处理用户查询"Python中如何处理JSON文件？"。描述从查询到生成答案的完整流程，包括每个步骤的输入输出。</p>
<p><em>Hint: 考虑查询编码、检索、上下文构建和生成四个主要阶段。</em></p>
<details>
<summary>参考答案</summary>
<p>完整RAG流程：</p>
<ol>
<li>
<p><strong>查询处理阶段</strong>
   - 输入：原始查询 "Python中如何处理JSON文件？"
   - 处理：</p>
<ul>
<li>意图识别：技术问题/编程指导</li>
<li>关键词提取：Python, JSON, 处理</li>
<li>查询扩展：添加同义词如"读取"、"解析"、"写入"</li>
<li>输出：扩展查询集合</li>
</ul>
</li>
<li>
<p><strong>向量检索阶段</strong>
   - 输入：扩展后的查询
   - 处理：</p>
<ul>
<li>查询编码：转换为768维向量</li>
<li>向量检索：在Python文档索引中搜索</li>
<li>初步筛选：返回Top-10相关文档</li>
<li>输出：候选文档列表</li>
</ul>
</li>
<li>
<p><strong>重排序阶段</strong>
   - 输入：候选文档列表
   - 处理：</p>
<ul>
<li>交叉编码器评分</li>
<li>考虑文档权威性（官方文档优先）</li>
<li>去重处理</li>
<li>输出：Top-3最相关文档</li>
</ul>
</li>
<li>
<p><strong>上下文构建阶段</strong>
   - 输入：排序后的文档
   - 处理：</p>
<ul>
<li>提取关键段落</li>
<li>组织成结构化prompt</li>
<li>添加示例代码片段</li>
<li>输出：增强上下文</li>
</ul>
</li>
<li>
<p><strong>答案生成阶段</strong>
   - 输入：查询 + 增强上下文
   - 处理：</p>
<ul>
<li>调用LLM生成答案</li>
<li>整合多个文档信息</li>
<li>添加代码示例</li>
<li>输出：完整答案，包含json.load()、json.dump()等方法说明</li>
</ul>
</li>
</ol>
</details>
<p><strong>练习9.2：向量数据库选择</strong></p>
<p>比较Faiss、Weaviate和Pinecone三种向量数据库，分析它们在构建聊天机器人RAG系统时的优缺点。考虑因素包括：性能、可扩展性、易用性和成本。</p>
<p><em>Hint: 考虑开源vs商业、本地vs云端、功能完整性等维度。</em></p>
<details>
<summary>参考答案</summary>
<p>向量数据库对比分析：</p>
<p><strong>Faiss（Facebook AI Similarity Search）</strong></p>
<ul>
<li>优点：</li>
<li>开源免费，无限制使用</li>
<li>性能极高，支持GPU加速</li>
<li>算法选择丰富（Flat, IVF, HNSW等）</li>
<li>内存效率高，支持量化压缩</li>
<li>缺点：</li>
<li>纯向量搜索库，缺少数据管理功能</li>
<li>需要自行实现持久化、分布式等</li>
<li>没有内置的元数据过滤</li>
<li>学习曲线较陡峭</li>
<li>适用场景：技术团队强，需要极致性能，成本敏感</li>
</ul>
<p><strong>Weaviate</strong></p>
<ul>
<li>优点：</li>
<li>开源，可自托管或使用云服务</li>
<li>功能完整：向量搜索+传统搜索+GraphQL API</li>
<li>内置多种ML模型集成</li>
<li>支持混合搜索（向量+关键词）</li>
<li>Schema管理和数据验证</li>
<li>缺点：</li>
<li>资源消耗较大</li>
<li>部署和运维相对复杂</li>
<li>性能不如纯向量引擎</li>
<li>适用场景：需要完整数据库功能，中等规模应用</li>
</ul>
<p><strong>Pinecone</strong></p>
<ul>
<li>优点：</li>
<li>完全托管的云服务，零运维</li>
<li>简单易用的API</li>
<li>自动扩展，高可用性</li>
<li>内置监控和分析</li>
<li>支持元数据过滤和namespace隔离</li>
<li>缺点：</li>
<li>商业服务，成本较高</li>
<li>数据存储在第三方</li>
<li>定制能力有限</li>
<li>存在vendor lock-in风险</li>
<li>适用场景：快速原型开发，不想管理基础设施，预算充足</li>
</ul>
<p><strong>聊天机器人场景推荐</strong>：</p>
<ul>
<li>原型阶段：Pinecone（快速验证）</li>
<li>小规模部署：Weaviate（功能平衡）</li>
<li>大规模生产：Faiss + 自建管理层（性能优先）</li>
</ul>
</details>
<p><strong>练习9.3：缓存策略设计</strong></p>
<p>为一个日活100万的聊天机器人设计三级缓存策略。要求：</p>
<ol>
<li>L1缓存命中率达到20%</li>
<li>L2缓存命中率达到40%</li>
<li>整体响应时间P95 &lt; 500ms</li>
</ol>
<p><em>Hint: 考虑缓存大小、更新策略、失效机制。</em></p>
<details>
<summary>参考答案</summary>
<p>三级缓存架构设计：</p>
<p><strong>L1缓存：精确匹配缓存</strong></p>
<ul>
<li>存储：Redis集群，内存12GB</li>
<li>容量：约10万条查询-答案对</li>
<li>TTL：</li>
<li>热门问题：24小时</li>
<li>普通问题：2小时</li>
<li>匹配策略：MD5哈希精确匹配</li>
<li>预期命中率：20-25%</li>
<li>响应时间：&lt;5ms</li>
</ul>
<p><strong>L2缓存：语义相似缓存</strong></p>
<ul>
<li>存储：向量数据库（内存索引）</li>
<li>容量：约50万条查询向量</li>
<li>相似度阈值：余弦相似度 &gt; 0.93</li>
<li>更新策略：</li>
<li>LRU淘汰</li>
<li>热度加权（访问频率 × 时间衰减）</li>
<li>预期命中率：40-45%（累计）</li>
<li>响应时间：&lt;50ms</li>
</ul>
<p><strong>L3缓存：文档缓存</strong></p>
<ul>
<li>存储：SSD缓存 + CDN</li>
<li>容量：Top 10000热门文档</li>
<li>组织方式：</li>
<li>按主题分片</li>
<li>预计算的embedding</li>
<li>更新策略：</li>
<li>每日凌晨批量更新</li>
<li>增量实时更新</li>
<li>作用：加速检索，减少重复编码</li>
<li>响应时间贡献：减少100-200ms</li>
</ul>
<p><strong>缓存预热策略</strong>：</p>
<ol>
<li>启动时加载高频查询TOP 1000</li>
<li>基于历史日志预测当日热点</li>
<li>新内容发布时主动缓存相关查询</li>
</ol>
<p><strong>监控指标</strong>：</p>
<ul>
<li>各级命中率实时监控</li>
<li>缓存穿透率 &lt; 1%</li>
<li>缓存雪崩防护（随机TTL偏移）</li>
</ul>
<p><strong>成本估算</strong>：</p>
<ul>
<li>Redis: 12GB × $0.1/GB/月 = $1.2/月</li>
<li>向量索引: 自建服务器 $500/月</li>
<li>CDN: 1TB流量 × $0.05/GB = $50/月</li>
<li>总计: 约$550/月，每个请求成本 &lt; $0.0001</li>
</ul>
</details>
<p><strong>练习9.4：对话历史索引优化</strong></p>
<p>设计一个对话历史索引方案，要求支持：</p>
<ol>
<li>快速检索用户最近30天的相关对话</li>
<li>支持模糊记忆（"我上周问过的那个关于..."）</li>
<li>隐私合规，支持用户数据删除</li>
</ol>
<p><em>Hint: 考虑索引结构、分片策略、隐私设计。</em></p>
<details>
<summary>参考答案</summary>
<p>对话历史索引方案：</p>
<p><strong>索引架构</strong></p>
<div class="codehilite"><pre><span></span><code>用户索引层
├── UserID_Recent (最近7天，热数据)
├── UserID_Month (8-30天，温数据)
└── UserID_Archive (30天+，冷数据)

每层内部结构：
├── 会话索引
│   ├── SessionID
│   ├── 起止时间
│   ├── 主题标签
│   └── 摘要embedding
└── 消息索引
    ├── MessageID
    ├── 时间戳
    ├── 内容embedding
    └── 实体标注
</code></pre></div>

<p><strong>分片策略</strong></p>
<ol>
<li>按UserID哈希分片（保证同一用户数据局部性）</li>
<li>按时间范围分层（优化常见查询）</li>
<li>热数据保持在内存，冷数据使用SSD</li>
</ol>
<p><strong>模糊记忆实现</strong></p>
<ol>
<li>
<p><strong>时间解析</strong>
   - "上周" → [当前时间-7天, 当前时间-14天]
   - "最近" → [当前时间, 当前时间-3天]
   - 使用规则引擎解析自然语言时间</p>
</li>
<li>
<p><strong>主题提取</strong>
   - NER识别关键实体
   - 关键词提取（TF-IDF）
   - 意图分类标签</p>
</li>
<li>
<p><strong>模糊匹配</strong>
   - 时间范围过滤 + 语义相似度排序
   - 支持部分信息检索（只记得片段）</p>
</li>
</ol>
<p><strong>隐私合规设计</strong></p>
<ol>
<li>
<p><strong>数据加密</strong>
   - 用户数据AES-256加密存储
   - 每用户独立密钥</p>
</li>
<li>
<p><strong>删除机制</strong>
   - 软删除：标记删除，30天后物理删除
   - 硬删除：立即物理删除 + 索引清理
   - 级联删除：删除所有相关embedding和缓存</p>
</li>
<li>
<p><strong>审计日志</strong>
   - 记录所有数据访问
   - 定期隐私审计</p>
</li>
<li>
<p><strong>数据最小化</strong>
   - 仅索引必要信息
   - 定期清理过期数据
   - 匿名化处理敏感信息</p>
</li>
</ol>
<p><strong>性能优化</strong></p>
<ul>
<li>布隆过滤器加速存在性检查</li>
<li>预计算的每日/每周摘要</li>
<li>异步索引更新，不阻塞对话</li>
</ul>
</details>
<h3 id="_9">挑战题</h3>
<p><strong>练习9.5：多模态RAG设计</strong></p>
<p>设计一个支持文本、图片和表格的多模态RAG系统。用户可能会问："上次分享的销售报表中Q3的增长率是多少？"系统需要检索包含表格的PDF文档并提取答案。</p>
<p><em>Hint: 考虑多模态编码、跨模态检索、结构化数据提取。</em></p>
<details>
<summary>参考答案</summary>
<p>多模态RAG系统设计：</p>
<ol>
<li><strong>多模态索引构建</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="err">文档处理</span><span class="n">Pipeline</span><span class="o">:</span>
<span class="n">PDF输入</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="err">内容分离</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="err">多模态编码</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="err">统一索引</span>
<span class="w">         </span><span class="err">↓</span>
<span class="w">    </span><span class="err">├──</span><span class="w"> </span><span class="err">文本提取</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Text</span><span class="w"> </span><span class="n">Encoder</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="err">文本向量</span>
<span class="w">    </span><span class="err">├──</span><span class="w"> </span><span class="err">图片提取</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Vision</span><span class="w"> </span><span class="n">Encoder</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="err">图像向量</span>
<span class="w">    </span><span class="err">└──</span><span class="w"> </span><span class="err">表格提取</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Table</span><span class="w"> </span><span class="n">Parser</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="err">结构化数据</span>
<span class="w">                                  </span><span class="err">↓</span>
<span class="w">                            </span><span class="err">表格文本化</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="err">文本向量</span>
</code></pre></div>

<ol start="2">
<li>
<p><strong>编码器选择</strong>
- 文本：BGE-M3（支持中英文）
- 图像：CLIP ViT-L/14
- 统一空间：ALIGN模型（文本-图像对齐）
- 表格：专门的Table-BERT + 规则解析</p>
</li>
<li>
<p><strong>跨模态检索策略</strong></p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">multimodal_retrieve</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="c1"># 1. 查询理解</span>
    <span class="n">modality</span> <span class="o">=</span> <span class="n">detect_query_modality</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="n">entities</span> <span class="o">=</span> <span class="n">extract_entities</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>  <span class="c1"># &quot;Q3&quot;, &quot;增长率&quot;</span>

    <span class="c1"># 2. 多路检索</span>
    <span class="n">text_results</span> <span class="o">=</span> <span class="n">text_index</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="c1"># 如果提到表格相关词汇</span>
    <span class="k">if</span> <span class="s2">&quot;报表&quot;</span> <span class="ow">in</span> <span class="n">query</span> <span class="ow">or</span> <span class="s2">&quot;表格&quot;</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
        <span class="n">table_results</span> <span class="o">=</span> <span class="n">table_index</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
            <span class="n">structured_query</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="s2">&quot;增长率&quot;</span><span class="p">,</span> <span class="s2">&quot;period&quot;</span><span class="p">:</span> <span class="s2">&quot;Q3&quot;</span><span class="p">}</span>
        <span class="p">)</span>

    <span class="c1"># 3. 融合排序</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">merge_multimodal_results</span><span class="p">(</span>
        <span class="n">text_results</span><span class="p">,</span> 
        <span class="n">table_results</span><span class="p">,</span>
        <span class="n">weight_text</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
        <span class="n">weight_table</span><span class="o">=</span><span class="mf">0.6</span>  <span class="c1"># 表格优先</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span>
</code></pre></div>

<ol start="4">
<li><strong>表格数据处理</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">TableProcessor</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">parse_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_image_or_html</span><span class="p">):</span>
        <span class="c1"># 1. 表格检测与识别</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="n">detect_table_cells</span><span class="p">(</span><span class="n">table_image_or_html</span><span class="p">)</span>

        <span class="c1"># 2. 结构化提取</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="n">extract_headers</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">extract_rows</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span>

        <span class="c1"># 3. 语义标注</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">infer_table_schema</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">rows</span><span class="p">)</span>

        <span class="c1"># 4. 生成多种索引</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;full_text&#39;</span><span class="p">:</span> <span class="n">table_to_text</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">rows</span><span class="p">),</span>
            <span class="s1">&#39;structured&#39;</span><span class="p">:</span> <span class="n">table_to_json</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">rows</span><span class="p">),</span>
            <span class="s1">&#39;sql_ready&#39;</span><span class="p">:</span> <span class="n">table_to_sqlite</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">rows</span><span class="p">),</span>
            <span class="s1">&#39;summary&#39;</span><span class="p">:</span> <span class="n">generate_table_summary</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">rows</span><span class="p">)</span>
        <span class="p">}</span>
</code></pre></div>

<ol start="5">
<li><strong>答案提取</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">extract_answer</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">retrieved_docs</span><span class="p">):</span>
    <span class="n">answer_candidates</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">retrieved_docs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">doc</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;table&#39;</span><span class="p">:</span>
            <span class="c1"># SQL查询提取</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="n">text_to_sql</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">doc</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">execute_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">doc</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">answer_candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">doc</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span>
            <span class="c1"># 文本抽取</span>
            <span class="n">answer</span> <span class="o">=</span> <span class="n">extract_span</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">doc</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="n">answer_candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">doc</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span>
            <span class="c1"># VQA模型</span>
            <span class="n">answer</span> <span class="o">=</span> <span class="n">visual_qa</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">doc</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
            <span class="n">answer_candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>

    <span class="c1"># 答案验证与选择</span>
    <span class="n">final_answer</span> <span class="o">=</span> <span class="n">validate_and_merge</span><span class="p">(</span><span class="n">answer_candidates</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">final_answer</span>
</code></pre></div>

<ol start="6">
<li>
<p><strong>系统优化</strong>
- <strong>预处理优化</strong>：批量处理文档，缓存解析结果
- <strong>索引优化</strong>：表格数据预计算常见聚合指标
- <strong>查询优化</strong>：识别表格查询模式，直接路由到结构化检索
- <strong>准确性提升</strong>：对表格数据使用精确匹配 + 模糊匹配结合</p>
</li>
<li>
<p><strong>实际案例处理流程</strong></p>
</li>
</ol>
<p>查询："上次分享的销售报表中Q3的增长率是多少？"</p>
<ol>
<li>实体识别：时间="上次"，文档类型="销售报表"，指标="增长率"，时期="Q3"</li>
<li>检索范围：用户最近分享的文档，类型=报表</li>
<li>表格定位：找到包含"Q3"和"增长率"的表格</li>
<li>数据提取：从表格中提取(Q3, 增长率)单元格</li>
<li>答案生成："根据您上次分享的销售报表，Q3的增长率为15.3%"</li>
</ol>
</details>
<p><strong>练习9.6：实时RAG系统设计</strong></p>
<p>设计一个支持实时新闻对话的RAG系统。要求：</p>
<ol>
<li>新闻发布后5分钟内可被检索</li>
<li>支持10000 QPS的并发查询</li>
<li>保证信息时效性和准确性</li>
</ol>
<p><em>Hint: 考虑流式处理、增量索引、分布式架构。</em></p>
<details>
<summary>参考答案</summary>
<p>实时RAG系统架构：</p>
<ol>
<li><strong>数据摄入层</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code>新闻源 → Kafka队列 → 流处理Pipeline → 增量索引
  ↓         ↓             ↓
RSS订阅   消息去重    NLP处理(NER/摘要)
API推送   优先级排序   Embedding生成
爬虫采集  质量过滤     元数据提取
</code></pre></div>

<ol start="2">
<li><strong>流式处理架构</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">RealtimeIndexer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ContentCleaner</span><span class="p">(),</span>      <span class="c1"># 清洗</span>
            <span class="n">Deduplicator</span><span class="p">(),</span>       <span class="c1"># 去重</span>
            <span class="n">EntityExtractor</span><span class="p">(),</span>    <span class="c1"># 实体提取</span>
            <span class="n">Summarizer</span><span class="p">(),</span>        <span class="c1"># 摘要生成</span>
            <span class="n">Embedder</span><span class="p">(),</span>          <span class="c1"># 向量化</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_interval</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># 秒</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">process_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">news</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kafka_consumer</span><span class="p">:</span>
            <span class="c1"># 流水线处理</span>
            <span class="n">processed</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">news</span><span class="p">)</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">processed</span><span class="p">)</span>

            <span class="c1"># 批量索引</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_index</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
                <span class="n">batch</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">batch_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="c1"># 并行写入多个索引副本</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">primary_index</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">batch</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">secondary_index</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">batch</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache_layer</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="p">)</span>
</code></pre></div>

<ol start="3">
<li><strong>分布式索引设计</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code>负载均衡器
    ↓
查询路由层（10个节点）
    ↓
索引分片层
├── 热数据分片（最近1小时，内存）
│   ├── Shard1-1 (Master)
│   └── Shard1-2 (Replica)
├── 温数据分片（1-24小时，SSD）
│   ├── Shard2-1 (Master)
│   └── Shard2-2 (Replica)
└── 冷数据分片（24小时+，HDD）
    ├── Shard3-1 (Master)
    └── Shard3-2 (Replica)
</code></pre></div>

<ol start="4">
<li><strong>高并发优化</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">HighConcurrencyRAG</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 连接池</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_pool</span> <span class="o">=</span> <span class="n">ConnectionPool</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="c1"># 请求批处理</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_processor</span> <span class="o">=</span> <span class="n">BatchProcessor</span><span class="p">(</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
            <span class="n">timeout_ms</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">)</span>
        <span class="c1"># 结果缓存</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">LRUCache</span><span class="p">(</span><span class="n">capacity</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="c1"># 1. 缓存检查</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">cached</span>

        <span class="c1"># 2. 批处理队列</span>
        <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_processor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="c1"># 3. 并发检索</span>
        <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">future</span>

        <span class="c1"># 4. 缓存更新</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">batch_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queries</span><span class="p">):</span>
        <span class="c1"># 向量化批处理</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_encode</span><span class="p">(</span><span class="n">queries</span><span class="p">)</span>

        <span class="c1"># 并行分片查询</span>
        <span class="n">shard_results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="p">[</span>
            <span class="n">shard</span><span class="o">.</span><span class="n">search_batch</span><span class="p">(</span><span class="n">embeddings</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">shard</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shards</span>
        <span class="p">])</span>

        <span class="c1"># 结果合并</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_results</span><span class="p">(</span><span class="n">shard_results</span><span class="p">)</span>
</code></pre></div>

<ol start="5">
<li><strong>时效性保证</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">TimelinessManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_decay_factor</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># 每小时衰减</span>

    <span class="k">def</span> <span class="nf">score_with_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc_score</span><span class="p">,</span> <span class="n">doc_time</span><span class="p">):</span>
        <span class="n">age_hours</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">doc_time</span><span class="p">)</span><span class="o">.</span><span class="n">hours</span>
        <span class="n">time_score</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">time_decay_factor</span> <span class="o">*</span> <span class="n">age_hours</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">doc_score</span> <span class="o">*</span> <span class="mf">0.7</span> <span class="o">+</span> <span class="n">time_score</span> <span class="o">*</span> <span class="mf">0.3</span>

    <span class="k">def</span> <span class="nf">filter_outdated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">,</span> <span class="n">query_intent</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">query_intent</span> <span class="o">==</span> <span class="s2">&quot;breaking_news&quot;</span><span class="p">:</span>
            <span class="c1"># 只返回1小时内</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">docs</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">age</span> <span class="o">&lt;</span> <span class="mi">3600</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">query_intent</span> <span class="o">==</span> <span class="s2">&quot;recent_events&quot;</span><span class="p">:</span>
            <span class="c1"># 24小时内</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">docs</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">age</span> <span class="o">&lt;</span> <span class="mi">86400</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">docs</span>
</code></pre></div>

<ol start="6">
<li><strong>准确性验证</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">AccuracyValidator</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fact_checker</span> <span class="o">=</span> <span class="n">FactCheckAPI</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_ranker</span> <span class="o">=</span> <span class="n">SourceCredibility</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">news_item</span><span class="p">):</span>
        <span class="c1"># 1. 多源验证</span>
        <span class="n">similar_news</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_similar</span><span class="p">(</span><span class="n">news_item</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">similar_news</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">news_item</span><span class="o">.</span><span class="n">confidence</span> <span class="o">=</span> <span class="s2">&quot;low&quot;</span>

        <span class="c1"># 2. 来源可信度</span>
        <span class="n">source_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_ranker</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">news_item</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>

        <span class="c1"># 3. 事实核查</span>
        <span class="n">facts</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">fact_checker</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">news_item</span><span class="o">.</span><span class="n">claims</span><span class="p">)</span>

        <span class="c1"># 4. 综合评分</span>
        <span class="n">news_item</span><span class="o">.</span><span class="n">reliability</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">source_score</span> <span class="o">*</span> <span class="mf">0.4</span> <span class="o">+</span>
            <span class="n">facts</span><span class="o">.</span><span class="n">accuracy</span> <span class="o">*</span> <span class="mf">0.4</span> <span class="o">+</span>
            <span class="n">similar_news</span><span class="o">.</span><span class="n">consensus</span> <span class="o">*</span> <span class="mf">0.2</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">news_item</span>
</code></pre></div>

<ol start="7">
<li><strong>系统监控</strong></li>
</ol>
<p>关键指标：</p>
<ul>
<li>索引延迟：P99 &lt; 5分钟</li>
<li>查询延迟：P95 &lt; 100ms</li>
<li>并发能力：sustained 10K QPS</li>
<li>准确率：&gt; 95%（人工抽检）</li>
<li>时效性：新闻年龄中位数 &lt; 2小时</li>
</ul>
<ol start="8">
<li><strong>容错机制</strong>
- 主从复制：每个分片至少2个副本
- 自动故障转移：检测到节点故障自动切换
- 降级策略：高负载时返回缓存或近似结果
- 断路器：防止雪崩效应</li>
</ol>
</details>
<p><strong>练习9.7：RAG系统评估框架</strong></p>
<p>设计一个全面的RAG系统评估框架，包括离线评估和在线评估指标。如何平衡检索质量、生成质量和系统性能？</p>
<p><em>Hint: 考虑自动评估、人工评估、A/B测试。</em></p>
<details>
<summary>参考答案</summary>
<p>RAG评估框架设计：</p>
<ol>
<li><strong>离线评估体系</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">OfflineEvaluator</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_sets</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;factual_qa&#39;</span><span class="p">:</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s1">&#39;factual_questions&#39;</span><span class="p">),</span>
            <span class="s1">&#39;conversational&#39;</span><span class="p">:</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s1">&#39;dialogue_pairs&#39;</span><span class="p">),</span>
            <span class="s1">&#39;complex_reasoning&#39;</span><span class="p">:</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s1">&#39;multi_hop_qa&#39;</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">evaluate_retrieval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rag_system</span><span class="p">):</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># 检索质量指标</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;recall@k&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_recall</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;mrr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_mrr</span><span class="p">()</span>  <span class="c1"># Mean Reciprocal Rank</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;ndcg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_ndcg</span><span class="p">()</span>  <span class="c1"># Normalized DCG</span>

        <span class="c1"># 语义相关性</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;semantic_similarity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_semantic_sim</span><span class="p">()</span>

        <span class="c1"># 多样性指标</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;diversity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_diversity</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">metrics</span>

    <span class="k">def</span> <span class="nf">evaluate_generation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rag_system</span><span class="p">):</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># 自动指标</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;bleu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_bleu</span><span class="p">()</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;rouge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_rouge</span><span class="p">()</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;bertscore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_bertscore</span><span class="p">()</span>

        <span class="c1"># 事实一致性</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;factual_consistency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_facts</span><span class="p">()</span>

        <span class="c1"># 答案完整性</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;answer_completeness&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_completeness</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">metrics</span>
</code></pre></div>

<ol start="2">
<li><strong>在线评估指标</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">OnlineEvaluator</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_collector</span> <span class="o">=</span> <span class="n">MetricsCollector</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">track_performance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="c1"># 性能指标</span>
            <span class="s1">&#39;latency_p50&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_percentile</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
            <span class="s1">&#39;latency_p95&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_percentile</span><span class="p">(</span><span class="mi">95</span><span class="p">),</span>
            <span class="s1">&#39;latency_p99&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_percentile</span><span class="p">(</span><span class="mi">99</span><span class="p">),</span>
            <span class="s1">&#39;throughput&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_qps</span><span class="p">(),</span>

            <span class="c1"># 质量指标</span>
            <span class="s1">&#39;user_satisfaction&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_satisfaction_score</span><span class="p">(),</span>
            <span class="s1">&#39;resolution_rate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_resolution_rate</span><span class="p">(),</span>
            <span class="s1">&#39;escalation_rate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_escalation_rate</span><span class="p">(),</span>

            <span class="c1"># 用户行为</span>
            <span class="s1">&#39;reformulation_rate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_reformulation_rate</span><span class="p">(),</span>
            <span class="s1">&#39;session_length&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_avg_session_length</span><span class="p">(),</span>
            <span class="s1">&#39;engagement_rate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_engagement_rate</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">implicit_feedback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 隐式反馈信号</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;click_through_rate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ctr</span><span class="p">(),</span>
            <span class="s1">&#39;dwell_time&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_avg_dwell_time</span><span class="p">(),</span>
            <span class="s1">&#39;copy_rate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_copy_rate</span><span class="p">(),</span>  <span class="c1"># 用户复制答案</span>
            <span class="s1">&#39;follow_up_rate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_follow_up_rate</span><span class="p">()</span>
        <span class="p">}</span>
</code></pre></div>

<ol start="3">
<li><strong>A/B测试框架</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">ABTestFramework</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">setup_experiment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">variants</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;control&#39;</span><span class="p">:</span> <span class="n">variants</span><span class="p">[</span><span class="s1">&#39;control&#39;</span><span class="p">],</span>
            <span class="s1">&#39;treatment&#39;</span><span class="p">:</span> <span class="n">variants</span><span class="p">[</span><span class="s1">&#39;treatment&#39;</span><span class="p">],</span>
            <span class="s1">&#39;metrics&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;allocation&#39;</span><span class="p">:</span> <span class="mf">0.5</span>  <span class="c1"># 50-50分流</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">run_experiment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">duration_days</span><span class="o">=</span><span class="mi">7</span><span class="p">):</span>
        <span class="n">exp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

        <span class="c1"># 用户分流</span>
        <span class="k">def</span> <span class="nf">route_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hash</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">&lt;</span> <span class="n">exp</span><span class="p">[</span><span class="s1">&#39;allocation&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">exp</span><span class="p">[</span><span class="s1">&#39;treatment&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">exp</span><span class="p">[</span><span class="s1">&#39;control&#39;</span><span class="p">]</span>

        <span class="c1"># 收集指标</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;control&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;treatment&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>

        <span class="c1"># 统计分析</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_results</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">analyze_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
        <span class="c1"># 统计显著性检验</span>
        <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>

        <span class="n">control</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;control&#39;</span><span class="p">]</span>
        <span class="n">treatment</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;treatment&#39;</span><span class="p">]</span>

        <span class="c1"># T检验</span>
        <span class="n">t_stat</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">treatment</span><span class="p">)</span>

        <span class="c1"># 效应量（Cohen&#39;s d）</span>
        <span class="n">cohens_d</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean</span><span class="p">(</span><span class="n">treatment</span><span class="p">)</span> <span class="o">-</span> <span class="n">mean</span><span class="p">(</span><span class="n">control</span><span class="p">))</span> <span class="o">/</span> <span class="n">pooled_std</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;significant&#39;</span><span class="p">:</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">,</span>
            <span class="s1">&#39;p_value&#39;</span><span class="p">:</span> <span class="n">p_value</span><span class="p">,</span>
            <span class="s1">&#39;effect_size&#39;</span><span class="p">:</span> <span class="n">cohens_d</span><span class="p">,</span>
            <span class="s1">&#39;improvement&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">mean</span><span class="p">(</span><span class="n">treatment</span><span class="p">)</span> <span class="o">-</span> <span class="n">mean</span><span class="p">(</span><span class="n">control</span><span class="p">))</span> <span class="o">/</span> <span class="n">mean</span><span class="p">(</span><span class="n">control</span><span class="p">)</span>
        <span class="p">}</span>
</code></pre></div>

<ol start="4">
<li><strong>质量-性能平衡策略</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">QualityPerformanceBalancer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pareto_frontier</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">find_optimal_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configs</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">configs</span><span class="p">:</span>
            <span class="n">quality</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_quality</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
            <span class="n">performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_performance</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_cost</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span>
                <span class="s1">&#39;quality&#39;</span><span class="p">:</span> <span class="n">quality</span><span class="p">,</span>
                <span class="s1">&#39;latency&#39;</span><span class="p">:</span> <span class="n">performance</span><span class="p">[</span><span class="s1">&#39;latency&#39;</span><span class="p">],</span>
                <span class="s1">&#39;cost&#39;</span><span class="p">:</span> <span class="n">cost</span><span class="p">,</span>
                <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_score</span><span class="p">(</span><span class="n">quality</span><span class="p">,</span> <span class="n">performance</span><span class="p">,</span> <span class="n">cost</span><span class="p">)</span>
            <span class="p">})</span>

        <span class="c1"># 多目标优化</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pareto_optimal</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quality</span><span class="p">,</span> <span class="n">performance</span><span class="p">,</span> <span class="n">cost</span><span class="p">):</span>
        <span class="c1"># 加权评分</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;quality&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="s1">&#39;latency&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
            <span class="s1">&#39;cost&#39;</span><span class="p">:</span> <span class="mf">0.2</span>
        <span class="p">}</span>

        <span class="n">normalized_latency</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">performance</span><span class="p">[</span><span class="s1">&#39;latency&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">normalized_cost</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">cost</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">weights</span><span class="p">[</span><span class="s1">&#39;quality&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">quality</span> <span class="o">+</span>
            <span class="n">weights</span><span class="p">[</span><span class="s1">&#39;latency&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">normalized_latency</span> <span class="o">+</span>
            <span class="n">weights</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">normalized_cost</span>
        <span class="p">)</span>
</code></pre></div>

<ol start="5">
<li><strong>人工评估流程</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">HumanEvaluation</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotators</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">guidelines</span> <span class="o">=</span> <span class="n">load_guidelines</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">setup_evaluation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_size</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="c1"># 分层采样</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stratified_sampling</span><span class="p">(</span><span class="n">sample_size</span><span class="p">)</span>

        <span class="c1"># 评估维度</span>
        <span class="n">dimensions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;relevance&#39;</span><span class="p">,</span>      <span class="c1"># 相关性 (1-5)</span>
            <span class="s1">&#39;accuracy&#39;</span><span class="p">,</span>       <span class="c1"># 准确性 (1-5)</span>
            <span class="s1">&#39;completeness&#39;</span><span class="p">,</span>   <span class="c1"># 完整性 (1-5)</span>
            <span class="s1">&#39;coherence&#39;</span><span class="p">,</span>      <span class="c1"># 连贯性 (1-5)</span>
            <span class="s1">&#39;helpfulness&#39;</span>     <span class="c1"># 有用性 (1-5)</span>
        <span class="p">]</span>

        <span class="c1"># 双盲评估</span>
        <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
            <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;system_a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anonymize</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;control&#39;</span><span class="p">])</span>
            <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;system_b&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anonymize</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;treatment&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">samples</span>

    <span class="k">def</span> <span class="nf">compute_agreement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">annotations</span><span class="p">):</span>
        <span class="c1"># Krippendorff&#39;s alpha</span>
        <span class="kn">from</span> <span class="nn">krippendorff</span> <span class="kn">import</span> <span class="n">alpha</span>

        <span class="k">return</span> <span class="n">alpha</span><span class="p">(</span>
            <span class="n">annotations</span><span class="p">,</span>
            <span class="n">level_of_measurement</span><span class="o">=</span><span class="s1">&#39;ordinal&#39;</span>
        <span class="p">)</span>
</code></pre></div>

<ol start="6">
<li><strong>持续监控仪表板</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">MonitoringDashboard</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">update_dashboard</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># 实时指标</span>
            <span class="s1">&#39;current_qps&#39;</span><span class="p">:</span> <span class="n">get_current_qps</span><span class="p">(),</span>
            <span class="s1">&#39;active_users&#39;</span><span class="p">:</span> <span class="n">get_active_users</span><span class="p">(),</span>
            <span class="s1">&#39;error_rate&#39;</span><span class="p">:</span> <span class="n">get_error_rate</span><span class="p">(),</span>

            <span class="c1"># 趋势分析</span>
            <span class="s1">&#39;quality_trend&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_trend</span><span class="p">(</span><span class="s1">&#39;quality&#39;</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">),</span>
            <span class="s1">&#39;latency_trend&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_trend</span><span class="p">(</span><span class="s1">&#39;latency&#39;</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">),</span>
            <span class="s1">&#39;cost_trend&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_trend</span><span class="p">(</span><span class="s1">&#39;cost&#39;</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">),</span>

            <span class="c1"># 告警</span>
            <span class="s1">&#39;alerts&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_alerts</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">check_alerts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">alerts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;error_rate&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">:</span>
            <span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;High error rate detected&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;latency_p99&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Latency SLA violation&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;quality_score&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Quality degradation detected&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">alerts</span>
</code></pre></div>

<ol start="7">
<li><strong>评估指标权重配置</strong></li>
</ol>
<p>| 场景 | 检索质量 | 生成质量 | 延迟 | 成本 |</p>
<table>
<thead>
<tr>
<th>场景</th>
<th>检索质量</th>
<th>生成质量</th>
<th>延迟</th>
<th>成本</th>
</tr>
</thead>
<tbody>
<tr>
<td>客服机器人</td>
<td>30%</td>
<td>40%</td>
<td>20%</td>
<td>10%</td>
</tr>
<tr>
<td>知识问答</td>
<td>40%</td>
<td>35%</td>
<td>15%</td>
<td>10%</td>
</tr>
<tr>
<td>实时对话</td>
<td>25%</td>
<td>30%</td>
<td>35%</td>
<td>10%</td>
</tr>
<tr>
<td>研究助手</td>
<td>45%</td>
<td>40%</td>
<td>5%</td>
<td>10%</td>
</tr>
</tbody>
</table>
</details>
<p><strong>练习9.8：RAG失败模式分析</strong></p>
<p>分析RAG系统的常见失败模式，设计相应的检测和恢复机制。包括：检索失败、上下文污染、幻觉生成等。</p>
<p><em>Hint: 考虑失败检测、降级策略、用户体验优化。</em></p>
<details>
<summary>参考答案</summary>
<p>RAG失败模式分析与恢复机制：</p>
<ol>
<li><strong>检索失败模式</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">RetrievalFailureDetector</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_relevance_score</span> <span class="o">=</span> <span class="mf">0.7</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_doc_count</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">def</span> <span class="nf">detect_failures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">retrieved_docs</span><span class="p">):</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># 失败模式1：无相关文档</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">retrieved_docs</span><span class="p">:</span>
            <span class="n">failures</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;no_results&#39;</span><span class="p">,</span>
                <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span>
                <span class="s1">&#39;recovery&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_search_scope</span>
            <span class="p">})</span>

        <span class="c1"># 失败模式2：相关性过低</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">score</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_relevance_score</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">retrieved_docs</span><span class="p">):</span>
            <span class="n">failures</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;low_relevance&#39;</span><span class="p">,</span>
                <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span>
                <span class="s1">&#39;recovery&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reformulation</span>
            <span class="p">})</span>

        <span class="c1"># 失败模式3：结果过少</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">retrieved_docs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_doc_count</span><span class="p">:</span>
            <span class="n">failures</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;insufficient_results&#39;</span><span class="p">,</span>
                <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span>
                <span class="s1">&#39;recovery&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_threshold</span>
            <span class="p">})</span>

        <span class="c1"># 失败模式4：时效性问题</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_time_sensitive</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
            <span class="n">recent_docs</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">retrieved_docs</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">age</span> <span class="o">&lt;</span> <span class="mi">86400</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">recent_docs</span><span class="p">:</span>
                <span class="n">failures</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;outdated_info&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;recovery&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_realtime</span>
                <span class="p">})</span>

        <span class="k">return</span> <span class="n">failures</span>

    <span class="k">def</span> <span class="nf">recover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">failure</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">failure</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;no_results&#39;</span><span class="p">:</span>
            <span class="c1"># 扩大搜索范围</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_search_scope</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">failure</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;low_relevance&#39;</span><span class="p">:</span>
            <span class="c1"># 查询改写</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reformulation</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="c1"># ... 其他恢复策略</span>
</code></pre></div>

<ol start="2">
<li><strong>上下文污染检测</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">ContextPollutionDetector</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contradiction_detector</span> <span class="o">=</span> <span class="n">ContradictionModel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise_detector</span> <span class="o">=</span> <span class="n">NoiseDetector</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">detect_pollution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context_docs</span><span class="p">):</span>
        <span class="n">issues</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># 污染类型1：矛盾信息</span>
        <span class="n">contradictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_contradictions</span><span class="p">(</span><span class="n">context_docs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">contradictions</span><span class="p">:</span>
            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;contradictory_info&#39;</span><span class="p">,</span>
                <span class="s1">&#39;docs&#39;</span><span class="p">:</span> <span class="n">contradictions</span><span class="p">,</span>
                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;remove_or_clarify&#39;</span>
            <span class="p">})</span>

        <span class="c1"># 污染类型2：重复信息</span>
        <span class="n">duplicates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_duplicates</span><span class="p">(</span><span class="n">context_docs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">duplicates</span><span class="p">:</span>
            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;duplicate_info&#39;</span><span class="p">,</span>
                <span class="s1">&#39;docs&#39;</span><span class="p">:</span> <span class="n">duplicates</span><span class="p">,</span>
                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;deduplicate&#39;</span>
            <span class="p">})</span>

        <span class="c1"># 污染类型3：噪声信息</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_noise</span><span class="p">(</span><span class="n">context_docs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">noise</span><span class="p">:</span>
            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;noisy_context&#39;</span><span class="p">,</span>
                <span class="s1">&#39;docs&#39;</span><span class="p">:</span> <span class="n">noise</span><span class="p">,</span>
                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;filter_noise&#39;</span>
            <span class="p">})</span>

        <span class="c1"># 污染类型4：偏离主题</span>
        <span class="n">off_topic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_off_topic</span><span class="p">(</span><span class="n">context_docs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">off_topic</span><span class="p">:</span>
            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;off_topic&#39;</span><span class="p">,</span>
                <span class="s1">&#39;docs&#39;</span><span class="p">:</span> <span class="n">off_topic</span><span class="p">,</span>
                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;remove&#39;</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">issues</span>

    <span class="k">def</span> <span class="nf">clean_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context_docs</span><span class="p">,</span> <span class="n">issues</span><span class="p">):</span>
        <span class="n">cleaned</span> <span class="o">=</span> <span class="n">context_docs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">issue</span> <span class="ow">in</span> <span class="n">issues</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">issue</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;remove&#39;</span><span class="p">:</span>
                <span class="n">cleaned</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">cleaned</span> <span class="k">if</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">issue</span><span class="p">[</span><span class="s1">&#39;docs&#39;</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="n">issue</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;deduplicate&#39;</span><span class="p">:</span>
                <span class="n">cleaned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deduplicate</span><span class="p">(</span><span class="n">cleaned</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">issue</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;remove_or_clarify&#39;</span><span class="p">:</span>
                <span class="c1"># 添加免责声明</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_disclaimer</span><span class="p">(</span><span class="n">cleaned</span><span class="p">,</span> <span class="s2">&quot;信息可能存在分歧&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cleaned</span>
</code></pre></div>

<ol start="3">
<li><strong>幻觉检测与预防</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">HallucinationDetector</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fact_checker</span> <span class="o">=</span> <span class="n">FactChecker</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consistency_checker</span> <span class="o">=</span> <span class="n">ConsistencyChecker</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">detect_hallucination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generated_text</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">hallucinations</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># 检测类型1：事实错误</span>
        <span class="n">facts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_facts</span><span class="p">(</span><span class="n">generated_text</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fact</span> <span class="ow">in</span> <span class="n">facts</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_fact</span><span class="p">(</span><span class="n">fact</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
                <span class="n">hallucinations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;factual_error&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">fact</span><span class="p">,</span>
                    <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_confidence</span><span class="p">(</span><span class="n">fact</span><span class="p">)</span>
                <span class="p">})</span>

        <span class="c1"># 检测类型2：无中生有</span>
        <span class="n">entities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_entities</span><span class="p">(</span><span class="n">generated_text</span><span class="p">)</span>
        <span class="n">context_entities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_entities</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

        <span class="n">novel_entities</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">entities</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">context_entities</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">novel_entities</span><span class="p">:</span>
            <span class="n">hallucinations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;novel_information&#39;</span><span class="p">,</span>
                <span class="s1">&#39;entities&#39;</span><span class="p">:</span> <span class="n">novel_entities</span>
            <span class="p">})</span>

        <span class="c1"># 检测类型3：逻辑不一致</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_logical_consistency</span><span class="p">(</span><span class="n">generated_text</span><span class="p">):</span>
            <span class="n">hallucinations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;logical_inconsistency&#39;</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">hallucinations</span>

    <span class="k">def</span> <span class="nf">prevent_hallucination</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;temperature&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>  <span class="c1"># 降低随机性</span>
            <span class="s1">&#39;top_p&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>        <span class="c1"># 限制采样范围</span>
            <span class="s1">&#39;prompting&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;仅基于提供的信息回答&quot;</span><span class="p">,</span>
                <span class="s2">&quot;如果信息不足，请明确说明&quot;</span><span class="p">,</span>
                <span class="s2">&quot;不要推测或假设&quot;</span>
            <span class="p">],</span>
            <span class="s1">&#39;post_processing&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_and_filter</span>
        <span class="p">}</span>
</code></pre></div>

<ol start="4">
<li><strong>降级策略设计</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">DegradationStrategy</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategies</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;level_1&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_functionality</span><span class="p">,</span>
            <span class="s1">&#39;level_2&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduced_quality</span><span class="p">,</span>
            <span class="s1">&#39;level_3&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cached_only</span><span class="p">,</span>
            <span class="s1">&#39;level_4&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_response</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">select_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_state</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">system_state</span><span class="p">[</span><span class="s1">&#39;latency&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2000</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;level_3&#39;</span>  <span class="c1"># 仅缓存</span>
        <span class="k">elif</span> <span class="n">system_state</span><span class="p">[</span><span class="s1">&#39;error_rate&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;level_2&#39;</span>  <span class="c1"># 降质</span>
        <span class="k">elif</span> <span class="n">system_state</span><span class="p">[</span><span class="s1">&#39;load&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;level_2&#39;</span>  <span class="c1"># 降质</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;level_1&#39;</span>  <span class="c1"># 正常</span>

    <span class="k">def</span> <span class="nf">reduced_quality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="c1"># 降低检索数量</span>
        <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;top_k&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>  <span class="c1"># 原本10</span>
            <span class="s1">&#39;rerank&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># 跳过重排序</span>
            <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="s1">&#39;small&#39;</span><span class="p">,</span>  <span class="c1"># 使用小模型</span>
            <span class="s1">&#39;cache_first&#39;</span><span class="p">:</span> <span class="kc">True</span>  <span class="c1"># 优先缓存</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rag_with_config</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cached_only</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="c1"># 仅使用缓存</span>
        <span class="k">if</span> <span class="n">cached</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">cached</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_response</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">static_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="c1"># 静态响应</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;answer&#39;</span><span class="p">:</span> <span class="s2">&quot;系统繁忙，请稍后再试。您也可以查看常见问题解答。&quot;</span><span class="p">,</span>
            <span class="s1">&#39;fallback&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;suggestions&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_faq_suggestions</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="p">}</span>
</code></pre></div>

<ol start="5">
<li><strong>用户体验优化</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">UXOptimizer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response_templates</span> <span class="o">=</span> <span class="n">load_templates</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">handle_failure_gracefully</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">failure_type</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="n">responses</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;no_results&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_no_results</span><span class="p">,</span>
            <span class="s1">&#39;low_confidence&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_low_confidence</span><span class="p">,</span>
            <span class="s1">&#39;contradictory&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_contradictions</span><span class="p">,</span>
            <span class="s1">&#39;system_error&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_system_error</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">responses</span><span class="p">[</span><span class="n">failure_type</span><span class="p">](</span><span class="n">query</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_no_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s2">&quot;抱歉，我没有找到相关信息。&quot;</span><span class="p">,</span>
            <span class="s1">&#39;suggestions&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;尝试使用不同的关键词&quot;</span><span class="p">,</span>
                <span class="s2">&quot;查看相关主题&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suggest_similar_queries</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="s1">&#39;escalation&#39;</span><span class="p">:</span> <span class="s2">&quot;需要人工帮助吗？&quot;</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">handle_low_confidence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">answer</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;根据现有信息，</span><span class="si">{</span><span class="n">answer</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s1">&#39;disclaimer&#39;</span><span class="p">:</span> <span class="s2">&quot;⚠️ 此答案可能不够准确&quot;</span><span class="p">,</span>
            <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;查看原始资料&quot;</span><span class="p">,</span>
                <span class="s2">&quot;获取更多信息&quot;</span><span class="p">,</span>
                <span class="s2">&quot;联系专家&quot;</span>
            <span class="p">]</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">handle_contradictions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conflicting_info</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s2">&quot;发现了不同观点：&quot;</span><span class="p">,</span>
            <span class="s1">&#39;viewpoints&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">s</span><span class="p">,</span> <span class="s1">&#39;claim&#39;</span><span class="p">:</span> <span class="n">c</span><span class="p">}</span> 
                <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conflicting_info</span>
            <span class="p">],</span>
            <span class="s1">&#39;note&#39;</span><span class="p">:</span> <span class="s2">&quot;建议查阅多个来源以获得全面理解&quot;</span>
        <span class="p">}</span>
</code></pre></div>

<ol start="6">
<li><strong>失败恢复流程</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code>失败检测 → 分类评估 → 选择策略 → 执行恢复 → 验证结果
    ↓           ↓           ↓           ↓           ↓
监控指标    严重程度    降级/重试    补偿措施    质量检查
    ↓           ↓           ↓           ↓           ↓
触发阈值    影响范围    资源分配    用户通知    反馈收集
</code></pre></div>

<ol start="7">
<li><strong>监控与告警</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">FailureMonitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;retrieval_failure_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
            <span class="s1">&#39;hallucination_rate&#39;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">,</span>
            <span class="s1">&#39;context_pollution_rate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="s1">&#39;user_escalation_rate&#39;</span><span class="p">:</span> <span class="mf">0.03</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collect_metrics</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trigger_alert</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">trigger_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">alert</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
            <span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span>
            <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_severity</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;suggested_actions&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_suggested_actions</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="c1"># 发送告警</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_alert</span><span class="p">(</span><span class="n">alert</span><span class="p">)</span>

        <span class="c1"># 自动恢复</span>
        <span class="k">if</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;severity&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;critical&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auto_recover</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
</code></pre></div>

<ol start="8">
<li><strong>失败案例学习</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">FailureLearning</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failure_db</span> <span class="o">=</span> <span class="n">FailureDatabase</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">learn_from_failures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 收集失败案例</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure_db</span><span class="o">.</span><span class="n">get_recent_failures</span><span class="p">()</span>

        <span class="c1"># 模式识别</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_patterns</span><span class="p">(</span><span class="n">failures</span><span class="p">)</span>

        <span class="c1"># 更新策略</span>
        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pattern</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_detection_rules</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_recovery_strategies</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>

        <span class="c1"># 生成报告</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_failure_report</span><span class="p">(</span><span class="n">patterns</span><span class="p">)</span>
</code></pre></div>

</details>
            </article>
            
            <nav class="page-nav"><a href="chapter8.html" class="nav-link prev">← 第8章：人类反馈强化学习（RLHF/DPO）</a><a href="chapter10.html" class="nav-link next">第10章：高级RAG技术 →</a></nav>
        </main>
    </div>
</body>
</html>